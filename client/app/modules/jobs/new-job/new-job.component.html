<a class="ui button" routerLink="/jobs">
    <i class="chevron left icon"></i>Back to List
</a>

<h1>
    Create New Job
</h1>

<form #form="ngForm" class="ui form" id="new-job-form"
      (ngSubmit)="onSubmit(form)"
      novalidate>

    <!--Final Generated Name-->
    <div class="inline fields">
        <div class="read-only ten wide field">
            <label>Generated Name</label>
            <div *ngIf="usingFinalName" class="ui icon input" [class.loading]="generating">
                <input readonly="" type="text"
                       require
                       [(ngModel)]="finalName.result"
                       name="finalName">
                <i class="icon"></i>
            </div>
            <input *ngIf="!usingFinalName" readonly="" type="text"
                   require
                   [(ngModel)]="job.name"
                   name="finalName">
        </div>
        <div class="six wide field">
            <div class="ui toggle checkbox">
                <input type="checkbox" tabindex="0" class="hidden"
                       [checked]="usingFinalName"
                       (change)="usingFinalName = !usingFinalName">
                <label>Use generated name?</label>
            </div>
        </div>
    </div>

    <!--Client & Brand-->
    <div class="two fields">
        <div class="field" id="client-select-field">
            <label>Client</label>
            <select class="ui search dropdown selection"
                    [(ngModel)]="job.client"
                    (ngModelChange)="this.submitted = false; onClientChange()"
                    name="client">
                <option value=" ">(no client)</option>
                <option *ngFor="let cli of clients; let i = index"
                        [ngValue]="cli">
                    {{cli.name}} <span *ngIf="!commonService.isEmptyString(cli.shortCode)">- ({{cli.shortCode}})</span>
                </option>
            </select>
        </div>
        <div class="field" id="brand-select-field">
            <label>
                Brand
                <span [class.hidden]="commonService.isEmptyString(job?.client?.name)">
                    (can't find it?
                    <a id="new-brand-popup" class="popup-trigger"><i class="add icon"></i>add new</a>
                    <div class="ui popup" id="new-brand-popup-form">
                        <div class="ui input">
                          <input type="text" placeholder="(enter new brand)" #newBrandInput>
                        </div>
                        <div class="ui positive button"
                             (click)="addNewBrand(newBrandInput.value); newBrandInput.value = ''">Save</div>
                        <div class="ui button" (click)="addNewBrand('')">Cancel</div>
                    </div>
                    )
                </span>
                <span [class.hidden]="!commonService.isEmptyString(job?.client?.name)">
                    (needs client)
                </span>
            </label>
            <select class="ui search dropdown selection"
                    [(ngModel)]="job.brand"
                    (ngModelChange)="this.submitted = false; onBrandChange()"
                    name="brand">
                <option value=" ">(no brand)</option>
                <option *ngFor="let b of job.client.brands; let i = index"
                        [value]="b">{{b}}
                </option>
            </select>
        </div>
    </div>

    <!--Job Name-->
    <div class="required field" [class.error]="submitted && !name.valid">
        <label>Job Name</label>
        <input type="text"
               placeholder="(required name)"
               autofocus
               required
               [(ngModel)]="job.name"
               (ngModelChange)="this.submitted = false; onJobNameChange();"
               name="name"
               #name="ngModel">
    </div>

    <!--Start and End Dates-->
    <div class="two fields">
        <div class="required field" [class.error]="!startDate.valid">
            <label>Start Date (Month/Day/Year)</label>
            <input type="date"
                   required
                   [(ngModel)]="job.startDate"
                   (ngModelChange)="this.submitted = false; onDateChange('start', $event)"
                   name="startDate"
                   #startDate="ngModel">
        </div>
        <div class="required field" [class.error]="!endDate.valid">
            <label>End Date (Month/Day/Year)</label>
            <input type="date"
                   required
                   [(ngModel)]="job.endDate"
                   (ngModelChange)="this.submitted = false; onDateChange('end', $event)"
                   name="endDate"
                   #endDate="ngModel">
        </div>
    </div>

    <!--Rate Card Selector-->
    <app-rate-card-selector
            (onRateUpdated)="onRateUpdated($event)"
            #rateCardSelector>
    </app-rate-card-selector>

    <!--Description-->
    <div class="field">
        <label>Description</label>
        <textarea [(ngModel)]="job.description"
                  rows="3"
                  placeholder="(enter description)"
                  name="description">
        </textarea>
    </div>

    <!--Tags-->
    <div class="ui form">
        <div class="field">
            <label>Tags/Producers (can't find yours?
                <a id="new-tag-popup" class="popup-trigger"><i class="add icon"></i>add new</a>
                <div class="ui popup" id="new-tag-popup-form">
                    <div class="ui input">
                        <input type="text" placeholder="(enter new tag)" #newTagInput>
                    </div>
                    <div class="ui positive button"
                         (click)="addNewTag(newTagInput.value); newTagInput.value = ''">Save
                    </div>
                    <div class="ui button" (click)="addNewTag('')">Cancel</div>
                </div>
                )
            </label>
            <select multiple="" class="ui fluid search selection dropdown"
                    [(ngModel)]="job.tags"
                    name="tags"
                    #tagSelect="ngModel">
                <!--disabled will prevent selection of empty string tags-->
                <option value="" disabled="true">(select tags)</option>
                <option *ngFor="let t of tags;"
                        [value]="t.name">{{t.name}}
                </option>
            </select>
        </div>
    </div>

    <!--TODO: remaining features
        projectStatus select
        serviceType (toggle or select or radial)
        tags (form/list display like cakebook's ingredients; be careful of enter button)
        phases (not MVP(?))
    -->
    <div class="ui divider"></div>
    <div class="ui right floated large buttons">
        <button type="submit" class="ui positive button"
                [disabled]="!form.form.valid || submitted"><i class="checkmark icon"></i>Submit
        </button>
        <div class="or"></div>
        <button type="button" class="ui negative button"
                (click)="confirmResetModels()"><i class="refresh icon"></i>Clear
        </button>
    </div>

</form>


<div class="ui small modal" id="confirm-reset-job">
    <i class="close icon"></i>
    <div class="header">
        Are you sure you want to reset the fields on this form?
    </div>
    <div class="actions">
        <div class="ui positive button" (click)="resetModels()"><i class="checkmark icon"></i>I'm sure!</div>
        <div class="ui negative button"><i class="remove icon"></i>Nope</div>
    </div>
</div>


<!---->


<!--Final Confirmation Screen-->
<div class="ui long modal" id="confirm-new-job">
    <i class="close icon"></i>
    <div class="header">
        Almost there!
    </div>
    <div class="content">
        <!--TODO: display message representing current action-->
        <div class="ui active centered inline loader"
             *ngIf="!canEndConfirm"></div>
        <h2 class="ui center aligned icon header"
            *ngIf="canEndConfirm">
            <i class="green circular checkmark icon"></i>
            Done
        </h2>

        <h4 class="ui header">Processing rate card...</h4>
        <div class="ui fluid steps">
            <div class="step {{rateCardProcessingState}}">
                <i class="money icon"
                   [class.red]="rateCardProcessingState == 'failed'"
                   [class.remove]="rateCardProcessingState == 'failed'"></i>
                <div class="content">
                    <div class="title">Rate Card</div>
                    <div class="description">Copying bill rates over from template rate card</div>
                </div>
            </div>
        </div>

        <h4 class="ui header">Creating Folders in Box...</h4>
        <div class="ui fluid steps">
            <div class="step {{boxProcessingStates.client}}">
                <i class="users icon"></i>
                <div class="content">
                    <div class="title">Client</div>
                    <div class="description">Finding a folder<br>with the client's name</div>
                </div>
            </div>
            <div class="step {{boxProcessingStates.brand}}">
                <i class="trademark icon"></i>
                <div class="content">
                    <div class="title">Brand</div>
                    <div class="description">Finding a folder<br>with the brand name</div>
                </div>
            </div>
            <div class="step {{boxProcessingStates.job}}">
                <i class="suitcase icon"></i>
                <div class="content">
                    <div class="title">Job</div>
                    <div class="description">Creating a folder<br>with the job's<br> coded name</div>
                </div>
            </div>
        </div>
    </div>
    <div class="actions">
        <a class="ui button" routerLink="/jobs">
            <i class="chevron left icon"></i>Back to List
        </a>
        <div class="ui positive button"
             [class.disabled]="!canEndConfirm"
             (click)="endFinalConfirmation()">
            Check It Out<i class="chevron right icon"></i>
        </div>
    </div>
</div>